function asyncGeneratorStep(e,t,n,r,o,i,s){try{var c=e[i](s),a=c.value}catch(e){return void n(e)}c.done?t(a):Promise.resolve(a).then(r,o)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function s(e){asyncGeneratorStep(i,r,o,s,c,"next",e)}function c(e){asyncGeneratorStep(i,r,o,s,c,"throw",e)}s(void 0)})}}const fydeos={system:{isFydeOS:()=>"object"==typeof chrome.shellClient,isFileExist(e){var t=this;return _asyncToGenerator(function*(){let n=!1;try{yield t.ExecForResult(`ls ${e}`),n=!0}catch(e){n=!1}return n})()},mountRootRW(){var e=this;return _asyncToGenerator(function*(){yield e.ExecForResult("mount -o remount,rw /")})()},getLSBRelease(){var e=this;return _asyncToGenerator(function*(){try{return yield e.ExecForResult("cat /etc/lsb-release")}catch(e){return""}})()},getBoardName(){var e=this;return _asyncToGenerator(function*(){const t=yield e.getLSBRelease();if(!t||t.length<16)return"";const n=t.split("\n");let r="";for(let e=0;e<n.length;e+=1){const t=n[e],[o,i]=t.split("=");if(o&&i&&"CHROMEOS_RELEASE_BOARD"===o){r=i;break}}return r})()},getFydeOSVersion(){var e=this;return _asyncToGenerator(function*(){const t=yield e.getLSBRelease();if(!t||t.length<16)return"";const n=t.split("\n");let r="";for(let e=0;e<n.length;e+=1){const t=n[e],[o,i]=t.split("=");if(o&&i&&"CHROMEOS_RELEASE_BUILD_TYPE"===o){r=i.split("v")[1];break}}return r})()},getReleaseVersion(){var e=this;return _asyncToGenerator(function*(){const t=yield e.getLSBRelease();if(!t||t.length<16)return"";const n=t.split("\n");let r="";for(let e=0;e<n.length;e+=1){const t=n[e],[o,i]=t.split("=");if(o&&i&&"CHROMEOS_RELEASE_VERSION"===o){r=i;break}}return r})()},getLicenseId(){var e=this;return _asyncToGenerator(function*(){return(yield e.ExecForResult("/usr/share/fydeos_shell/license-utils.sh id")).trim()})()},downloadMiscScript(e){var t=this;return _asyncToGenerator(function*(){try{yield t.mountRootRW();const n=`curl https://fydeos.com/misc-scripts/${e} --output /usr/bin/${e}`;yield t.ExecForResult(n);const r=`chmod +x /usr/bin/${e}`;yield t.ExecForResult(r)}catch(e){}})()},ExecForResult:e=>new Promise(function(t,n){chrome.shellClient.execSync(e,function(e){0!==e.code?n(new Error(e.result)):t(e.result)})}),ExecForLongTask(e,t,n,r=300,o=1,i=1,s=null){chrome.shellClient.execAsync(e,function(e){if(-1==e.code)return n(new Error(e.result));var c=e.code,a=Math.round(r/o);!function e(){--a>=0?chrome.shellClient.getTaskOutput(c,i,function(r){switch(r.code){case chrome.shellClient.ON_PROCESS:s&&s(r.result);break;case chrome.shellClient.ON_CLOSED:return t(r.result);case chrome.shellClient.ON_ERROR:return n(new Error(r.result));default:return n(new Error("Task may be terminated by others"))}setTimeout(e,1e3*o)}):chrome.shellClient.forceCloseTask(c,function(){n(new Error("The mission is force closed for timeout!"))})}()})}},arc:{ANDROID_SHELL:"android_shell",INSTALL_APK_SH:"install_apk.sh",readyToInstallApps(e){var t=this;return _asyncToGenerator(function*(){if(0===e.length)return!1;const{ANDROID_SHELL:n}=fydeos.arc;(yield fydeos.system.isFileExist(`/usr/bin/${n}`))||(yield fydeos.system.downloadMiscScript(n));const r=yield t.getInstalledApps();for(const t of e)if(!r.includes(t))return!0;return!1})()},getInstalledApps:()=>_asyncToGenerator(function*(){return yield fydeos.system.ExecForResult("android_shell /system/bin/pm list package")})(),installApps:e=>_asyncToGenerator(function*(){if(0===e.length)return;const{INSTALL_APK_SH:t}=fydeos.arc;(yield fydeos.system.isFileExist(`/usr/bin/${t}`))||(yield fydeos.system.downloadMiscScript(t));let n=`bash /usr/bin/${t} `;for(const t of e){const e=`${Date.now()}${Math.random().toString(36).substring(2,6)}.apk`,r=`curl ${t} --output /tmp/${e}`;yield fydeos.system.ExecForResult(r),n+=`/tmp/${e} `}fydeos.system.ExecForLongTask(n,e=>{},e=>{},300,.5,5,e=>{})})(),checkUpdate(){var e=this;return _asyncToGenerator(function*(){chrome.appManagement.getArcPolicy(function(){var t=_asyncToGenerator(function*(t){if(!t)return;let n=[],r=[];const o=t.split(";");for(const e of o)if(0!==e.length){const t=e.split(",");2===t.length&&(n.push(t[0]),r.push(t[1]))}(yield e.readyToInstallApps(r))&&(yield e.installApps(n))});return function(e){return t.apply(this,arguments)}}())})()}},subscription:{NOTIFICATION_ID:"com.fydeos.subscription.notification",UPDATE_MIN_VERSION:"11.4",UP_SERVER_URL:"https://up.fydeos.com",CASHIER_SERVER_URL:"https://cashier.fydeos.com",LAST_NOTIFICATION_CACHE:"last_notification_cache",FILE_DISABLE_FYDEOS_OTA:"/mnt/stateful_partition/unencrypted/preserve/.disable_fydeos_ota",didNotifyInPeriod(e){var t=this;return _asyncToGenerator(function*(){const{LAST_NOTIFICATION_CACHE:n}=t,r=yield getChromeLocalStorage(n);return!!r&&Math.floor((Date.now()-r)/1e3)<e})()},otaDisabled(){var e=this;return _asyncToGenerator(function*(){return!!(yield fydeos.system.isFileExist(e.FILE_DISABLE_FYDEOS_OTA))})()},licenseCanUpgrade(e){var t=this;return _asyncToGenerator(function*(){try{const n=yield(yield fetch(`${t.CASHIER_SERVER_URL}/api/license/upgrade/${e}`)).json(),{canUpgrade:r}=n;return r}catch(e){return!0}})()},requestUtah(e){var t=this;return _asyncToGenerator(function*(){let n={};try{n=yield(yield fetch(`${t.UP_SERVER_URL}/fydeos/updatecheck/${e}`)).json()}catch(e){}return n})()},licenseRemainingSeconds(e){var t=this;return _asyncToGenerator(function*(){try{const n=yield(yield fetch(`${t.CASHIER_SERVER_URL}/api/license/status/${e}`)).json(),{status:r}=n,{expiryDate:o}=r;return Math.floor((Date.parse(o)-Date.now())/1e3)}catch(e){return}})()},willExpired:e=>e>0&&e<=604800,isExpired:e=>e<=0,remindLicense(e){var t=this;return _asyncToGenerator(function*(){yield t.popupNotification(e,"Remind"),yield PushNotification.responseServer({licenseId:e,type:"Remind"})})()},renewLicense(e){var t=this;return _asyncToGenerator(function*(){yield t.popupNotification(e,"Renew"),yield PushNotification.responseServer({licenseId:e,type:"Renew"})})()},singleUpgradeLicense(e){var t=this;return _asyncToGenerator(function*(){yield t.popupNotification(e,"SingleUpgrade"),yield PushNotification.responseServer({licenseId:e,type:"SingleUpgrade"})})()},checkRenew(){var e=this;return _asyncToGenerator(function*(){if((yield e.otaDisabled())||(yield e.didNotifyInPeriod(3600)))return;const t=yield fydeos.system.getLicenseId(),n=yield fydeos.system.getBoardName(),r=yield fydeos.system.getFydeOSVersion(),o=yield fydeos.system.getReleaseVersion();try{if("amd64-fydeos"===n){if(yield e.licenseCanUpgrade(t))return;const{UpdateAbortReason:n,NewVersion:i}=yield e.requestUtah(t);5===n&&compareVersions(r,e.UPDATE_MIN_VERSION)>=0&&compareVersions(o,i)<0&&(yield e.singleUpgradeLicense(t))}else{const n=yield e.licenseRemainingSeconds(t);if(isNaN(n))return;if(e.isExpired(n))yield e.renewLicense(t);else if(e.willExpired(n))yield e.remindLicense(t);else{if(yield e.licenseCanUpgrade(t))return;const{UpdateAbortReason:n,NewVersion:i}=yield e.requestUtah(t);3===n&&compareVersions(r,e.UPDATE_MIN_VERSION)>=0&&compareVersions(o,i)<0&&(yield e.singleUpgradeLicense(t))}}}catch(e){}})()},popupNotification(e,t,n){var r=this;return _asyncToGenerator(function*(){const n=Date.now(),o=`${r.NOTIFICATION_ID}.${t}.${n}`;chrome.notifications.create(o,{type:"basic",title:chrome.i18n.getMessage(`subscriptionNotification${t}Title`),message:chrome.i18n.getMessage(`subscriptionNotification${t}Message`),iconUrl:"assets/icon_128.png",requireInteraction:!0,priority:2,buttons:[{title:chrome.i18n.getMessage("subscriptionNotificationButtonConfirm")},{title:chrome.i18n.getMessage("subscriptionNotificationButtonIgnore")}]}),chrome.notifications.onClicked.addListener(function(){var n=_asyncToGenerator(function*(n){n===o&&(yield r.openUrl(t,e),chrome.notifications.clear(n))});return function(e){return n.apply(this,arguments)}}()),chrome.notifications.onButtonClicked.addListener(function(){var n=_asyncToGenerator(function*(n,i){n===o&&(0===i?yield r.openUrl(t,e):1===i&&chrome.notifications.clear(n))});return function(e,t){return n.apply(this,arguments)}}());const i=Date.now();yield setChromeLocalStorage({[r.LAST_NOTIFICATION_CACHE]:i})})()},openUrl(e,t){var n=this;return _asyncToGenerator(function*(){if("Renew"===e||"Remind"===e){const e=`${n.CASHIER_SERVER_URL}/web/checkoutCounter.html?licenseId=${t}`;chrome.windows.create({url:e})}else if("SingleUpgrade"===e){const{NewVersion:e}=yield n.requestUtah(t),r=`${n.CASHIER_SERVER_URL}/web/upgradeCheckoutCounter.html?licenseId=${t}&ver=${e}`;chrome.windows.create({url:r})}})()}},notification:{NOTIFICATION_ID:"com.fydeos.system.notification",needsDisplay:e=>_asyncToGenerator(function*(){const{forced:t,lang:n,boardName:r,minVersion:o,maxVersion:i,content:s,uuid:c}=e;return!!t||!!getChromeLanguage().includes(n)&&(!(compareVersions(yield fydeos.system.getFydeOSVersion(),o)<0)&&(!(compareVersions(yield fydeos.system.getFydeOSVersion(),i)>0)&&((yield fydeos.system.getBoardName())===r&&c!==(yield getChromeLocalStorage("push_id")))))})(),create(e){const{title:t,message:n,url:r}=e,o=Date.now(),i=`${this.NOTIFICATION_ID}.${o}`;chrome.notifications.create(i,{type:"basic",title:t,message:n,iconUrl:"assets/icon_128.png",requireInteraction:!0,priority:2}),chrome.notifications.onClicked.addListener(e=>{e===i&&r&&(chrome.windows.create({url:r}),chrome.notifications.clear(e))})}}};